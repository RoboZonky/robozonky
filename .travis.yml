language: java
git: # makes Git blame work in Sonar
  depth: 999999
env:
  global:
    - JAVA_OPTS=-Xmx2g
    - MAVEN_OPTS=$JAVA_OPTS
  matrix:
    # mandatory modules first
    - MODULE=robozonky-api
    - MODULE=robozonky-common
    - MODULE=robozonky-notifications
    - MODULE=robozonky-app
    - MODULE=robozonky-installer
    # then plugin modules
    - MODULE=robozonky-strategy-natural
    - MODULE=robozonky-integration-zonkoid
    # finally distributions
    - MODULE=robozonky-distribution/robozonky-distribution-full,robozonky-distribution/robozonky-distribution-installer
os:
  - linux
jdk:
  - openjdk8
  - openjdk10
  - oraclejdk8
  - oraclejdk10
stages: # order the stages we'll use during this build
  - precache
  - test
  - preview
  - sonar
matrix:
  include:
  - stage: precache # independent stage for Maven to build and download all dependencies
    script:
      - mvn dependency:go-offline # no need to run through the usual script, this is mostly no-op
    env: # empty
  - stage: preview # test early adopters JDK as well, but relax requirements
    env: #empty
    jdk: openjdk-ea
    allow_failures: true
    script: mvn --batch-mode test -Dassembly.skipAssembly -Dgpg.skip
  - stage: sonar # independent build stage for Sonar code analysis
    env: # empty
    addons:
      sonarcloud:
        organization: "robozonky"
        token:
          secure: $SONAR_TOKEN
    script: # use "test" phase instead of "install", so that PITest is not executed, speeding up the build
      - mvn org.jacoco:jacoco-maven-plugin:prepare-agent test sonar:sonar
cache:
  directories:
  - $HOME/.m2
install: # by default, build everything and skip tests
  - mvn --batch-mode -pl $MODULE -am install -DskipTests -Dgpg.skip
script: # by default, run all tests incl. PITest, skipping all assemblies
  - mvn --batch-mode -pl $MODULE install -Dassembly.skipAssembly -Dgpg.skip
